<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Student Learning Platform{% endblock %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        .topbar {
            background: #222;
            color: #fff;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logout-btn {
            color: #fff;
            text-decoration: none;
            background: #e74c3c;
            padding: 6px 16px;
            border-radius: 4px;
            margin-left: 10px;
        }
        .sidebar {
            width: 220px;
            background: #2c3e50;
            color: #fff;
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
            transition: width 0.2s;
            overflow-x: hidden;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar.collapsed {
            width: 60px;
        }
        .sidebar .toggle-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            margin: 10px 0 10px 10px;
            cursor: pointer;
            align-self: flex-start;
        }
        .sidebar ul { list-style: none; padding: 0; margin: 0; }
        .sidebar li {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
            white-space: nowrap;
        }
        .sidebar li:hover { background: #34495e; }
        .sidebar i {
            margin-right: 12px;
            min-width: 20px;
            text-align: center;
            font-size: 18px;
            transition: margin 0.2s;
        }
        .sidebar.collapsed .nav-label {
            display: none;
        }
        .sidebar.collapsed li {
            justify-content: center;
            padding: 15px 0;
        }
        .sidebar.collapsed i {
            margin-right: 0;
        }
        .sidebar .dropdown-content {
            display: none;
            background: #34495e;
            margin-left: 10px;
            border-left: 2px solid #2980b9;
            transition: max-height 0.3s;
            max-height: 0;
            overflow: hidden;
        }
        .sidebar .dropdown.open .dropdown-content {
            display: block;
            max-height: 500px;
            animation: dropdownFade 0.3s;
        }
        @keyframes dropdownFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .sidebar .dropdown > div {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .main-content {
            margin-left: 220px;
            padding: 30px;
            transition: margin-left 0.2s;
            box-sizing: border-box;
            width: calc(100% - 220px);
        }
        .sidebar.collapsed ~ .main-content {
            margin-left: 60px;
            width: calc(100% - 60px);
        }
        @media (max-width: 700px) {
            .sidebar { position: absolute; height: auto; }
            .main-content { margin-left: 0; width: 100%; }
        }
        /* Modal styles */
        .modal {
            display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background: rgba(0,0,0,0.4);
        }
        .modal-content {
            background: #fff; margin: 10% auto; padding: 20px; border-radius: 8px; width: 300px; color: #222;
        }
        .close-modal {
            color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .close-modal:hover { color: #e74c3c; }
        .modal label { display: block; margin-top: 10px; }
        .modal input, .modal textarea { width: 100%; margin-top: 5px; }
        .modal button { margin-top: 15px; }
        /* New styles */
        .sidebar .nav-label {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div>
            <strong>Student Learning Platform</strong>
        </div>
        <div>
            {% if user.is_authenticated %}
                <span><i class="fa fa-user"></i> {{ user.username }}</span>
                <a href="{% url 'logout' %}" class="logout-btn"><i class="fa fa-sign-out-alt"></i> Logout</a>
            {% endif %}
        </div>
    </div>
    <div class="sidebar" id="sidebar">
        <button class="toggle-btn" onclick="toggleSidebar()"><i class="fa fa-bars"></i></button>
        <ul>
            <li onclick="navigateTo('dashboard')"><i class="fa fa-home"></i> <span class="nav-label">Dashboard</span></li>
            <li onclick="openCreateModuleDialog()"><i class="fa fa-plus"></i> <span class="nav-label">Create Module</span></li>
            <li class="dropdown" id="modulesDropdown">
                <div onclick="toggleDropdown('modulesDropdown')">
                    <i class="fa fa-folder"></i> <span class="nav-label">Modules</span> <i class="fa fa-caret-down" style="margin-left:auto;"></i>
                </div>
                <ul class="dropdown-content" id="modulesList">
                    <!-- Modules will be populated here -->
                </ul>
            </li>
        </ul>
    </div>
    <div class="main-content" id="mainContent">
        {% block content %}{% endblock %}
    </div>

    <!-- Modal for Create Module -->
    <div id="createModuleModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeCreateModuleDialog()">Ã—</span>
            <h3>Create Module</h3>
            <form id="createModuleForm">
                <label for="moduleName">Name</label>
                <input type="text" id="moduleName" name="name" required>
                <label for="moduleDesc">Description</label>
                <textarea id="moduleDesc" name="description"></textarea>
                <button type="submit">Create</button>
            </form>
            <div id="createModuleError" style="color:red;"></div>
        </div>
    </div>

    <script>
        // CSRF helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const isCollapsed = sidebar.classList.toggle('collapsed');
            document.querySelector('.main-content').classList.toggle('collapsed');
            if (isCollapsed) {
                // Close all open dropdowns when collapsing
                document.querySelectorAll('.sidebar .dropdown.open').forEach(el => el.classList.remove('open'));
            }
        }

        function toggleDropdown(id) {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('collapsed')) {
                toggleSidebar(); // Expand the sidebar first
            }
            const el = document.getElementById(id);
            if (el) el.classList.toggle('open');
        }

        function navigateTo(page) {
            if (page === 'dashboard') {
                window.location.href = '/dashboard/';
            }
            // Add more navigation as needed
        }

        function openCreateModuleDialog() {
            document.getElementById('createModuleModal').style.display = 'block';
        }

        function closeCreateModuleDialog() {
            document.getElementById('createModuleModal').style.display = 'none';
            document.getElementById('createModuleForm').reset();
            document.getElementById('createModuleError').innerText = '';
        }

        // Handle modal close on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('createModuleModal');
            if (event.target === modal) {
                closeCreateModuleDialog();
            }
        }

        // AJAX: Fetch modules and populate sidebar
        function fetchModules() {
            fetch('/modules/', {headers: {'X-Requested-With': 'XMLHttpRequest'}})
                .then(response => response.json())
                .then(data => {
                    const modulesList = document.getElementById('modulesList');
                    modulesList.innerHTML = '';
                    if (data.modules && data.modules.length > 0) {
                        data.modules.forEach(module => {
                            const moduleId = 'module-' + module.id;
                            const li = document.createElement('li');
                            li.className = 'dropdown';
                            li.id = moduleId;
                            li.innerHTML = `
                                <div onclick="toggleDropdown('${moduleId}')">
                                    <i class="fa fa-book"></i> <span class="nav-label">${module.name}</span> <i class="fa fa-caret-down" style="margin-left:auto;"></i>
                                </div>
                                <ul class="dropdown-content" id="module-contents-${module.id}">
                                    <li onclick="navigateToModule('${module.id}', 'documents')"><i class="fa fa-file"></i> <span class="nav-label">Documents</span></li>
                                    <li onclick="navigateToModule('${module.id}', 'notes')"><i class="fa fa-sticky-note"></i> <span class="nav-label">Notes</span></li>
                                    <li onclick="navigateToModule('${module.id}', 'youtube_notes')"><i class="fa fa-youtube"></i> <span class="nav-label">YouTube Notes</span></li>
                                    <li onclick="navigateToModule('${module.id}', 'quizzes')"><i class="fa fa-question-circle"></i> <span class="nav-label">Quizzes</span></li>
                                </ul>
                            `;
                            modulesList.appendChild(li);
                        });
                    } else {
                        modulesList.innerHTML = '<li><i class="fa fa-info-circle"></i> <span class="nav-label">No modules yet.</span></li>';
                    }
                });
        }

        function navigateToModule(moduleId, section) {
            window.location.href = `/modules/${moduleId}/${section}/`;
        }

        // AJAX: Create module
        document.getElementById('createModuleForm').onsubmit = function(e) {
            e.preventDefault();
            const name = document.getElementById('moduleName').value;
            const description = document.getElementById('moduleDesc').value;
            fetch('/modules/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `name=${encodeURIComponent(name)}&description=${encodeURIComponent(description)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('createModuleError').innerText = data.error;
                } else {
                    closeCreateModuleDialog();
                    fetchModules();
                }
            });
        };

        // Initial load
        fetchModules();
    </script>
</body>
</html>