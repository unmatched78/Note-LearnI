{% comment %} <!-- quiz_section.html -->
<section id="quiz-generation">
    <h3>Generate Quiz</h3>
    <form id="quizGenForm" method="post" action="{% url 'quiz_generation' %}">
      {% csrf_token %}
      <!-- Renamed hidden field from 'action' to 'quiz_action' -->
      <input type="hidden" name="quiz_action" value="generate_questions">
      <label for="prompt">Enter Prompt for Quiz Generation:</label>
      <textarea name="prompt" id="prompt" rows="4" cols="50" value="any instruction(optional)"></textarea>
      <br>
      <label for="num_questions">Number of Questions:</label>
      <input type="number" name="num_questions" id="num_questions" min="1" max="30" value="number of question to be generated" required>
      <br>
      <!-- Hidden field to hold text chunks from the uploaded file -->
      <input type="hidden" name="text_chunks" id="text_chunks">
      <button type="submit">Generate Quiz</button>
    </form>
    <div id="quizGenResponse"></div>
  </section>
  
  <section id="quiz-submission">
    <h3>Take Quiz</h3>
    <form id="quizSubmitForm" method="post" action="{% url 'quiz_submission' %}">
      {% csrf_token %}
      <!-- Hidden field with the quiz_id from quiz generation -->
      <input type="hidden" name="quiz_id" id="quiz_id">
      <div id="quizQuestions">
        <!-- Quiz questions will be dynamically injected here -->
      </div>
      <button type="submit">Submit Quiz</button>
    </form>
    <div id="quizFeedback" class="feedback"></div>
  </section>
  
  <script>
    // Handle quiz generation: Send form, then render quiz questions based on returned JSON.
    document.getElementById('quizGenForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      fetch(form.action, {
        method: 'POST',
        body: formData,
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          document.getElementById('quizGenResponse').innerText = data.error;
        } else {
          // Clear previous quiz generation response.
          document.getElementById('quizGenResponse').innerText = '';
          // Set the hidden quiz_id field.
          document.getElementById('quiz_id').value = data.quiz_id;
          // Render the questions.
          const quizQuestionsDiv = document.getElementById('quizQuestions');
          quizQuestionsDiv.innerHTML = '';
          const questions = data.questions.questions;
          questions.forEach((q, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question';
            const questionTitle = document.createElement('h4');
            questionTitle.textContent = `Q${index + 1}: ${q.question}`;
            questionDiv.appendChild(questionTitle);
            // Create radio buttons for each option.
            q.options.forEach(option => {
              const optionLabel = document.createElement('label');
              optionLabel.className = 'option';
              const radioInput = document.createElement('input');
              radioInput.type = 'radio';
              radioInput.name = 'Q' + (index + 1);
              radioInput.value = option;
              optionLabel.appendChild(radioInput);
              optionLabel.appendChild(document.createTextNode(" " + option));
              questionDiv.appendChild(optionLabel);
            });
            quizQuestionsDiv.appendChild(questionDiv);
          });
        }
      })
      .catch(error => console.error('Error in quiz generation:', error));
    });
  
    // Handle quiz submission: Serialize selected answers and send them via AJAX.
    document.getElementById('quizSubmitForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = e.target;
      const quiz_id = document.getElementById('quiz_id').value;
      const quizQuestionsDiv = document.getElementById('quizQuestions');
      const questionDivs = quizQuestionsDiv.getElementsByClassName('question');
      let student_answers = {};
      Array.from(questionDivs).forEach((div, index) => {
        const questionNumber = index + 1;
        const radios = div.querySelectorAll(`input[name="Q${questionNumber}"]`);
        let selected = "";
        radios.forEach(radio => {
          if (radio.checked) selected = radio.value;
        });
        student_answers["Q" + questionNumber] = selected;
      });
  
      // Prepare payload.
      const csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]').value;
      const payload = new URLSearchParams();
      payload.append("quiz_id", quiz_id);
      payload.append("student_answers", JSON.stringify(student_answers));
      payload.append("csrfmiddlewaretoken", csrfToken);
  
      fetch(form.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: payload.toString()
      })
      .then(response => response.json())
      .then(data => {
        const quizFeedbackDiv = document.getElementById('quizFeedback');
        if (data.error) {
          quizFeedbackDiv.innerText = data.error;
        } else {
          // Build detailed feedback.
          let feedbackHtml = `<p>You got ${data.total_correct} out of ${data.total_questions} correct!</p>`;
          data.feedback.forEach((item, index) => {
            feedbackHtml += `<div class="feedback-item" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc;">`;
            feedbackHtml += `<h4>Question ${index + 1}: ${item.question}</h4>`;
            // Display student's answer with visual indicator.
            if (item.is_correct) {
              feedbackHtml += `<p>Your answer: <strong>${item.student_answer}</strong> <span style="color: green;">✅ Correct</span></p>`;
            } else {
              feedbackHtml += `<p>Your answer: <strong>${item.student_answer}</strong> <span style="color: red;">❌ Incorrect</span></p>`;
              feedbackHtml += `<p>Correct answer: <strong>${item.correct_answer}</strong></p>`;
            }
            feedbackHtml += `</div>`;
          });
          quizFeedbackDiv.innerHTML = feedbackHtml;
        }
      })
      .catch(error => console.error('Error in quiz submission:', error));
    });
  </script>
   {% endcomment %}
   <!-- quiz_section.html -->
<section id="quiz-generation">
  <h3>Generate Quiz</h3>
  <form id="quizGenForm" method="post" action="{% url 'quiz_generation' %}">
    {% csrf_token %}
    <!-- Renamed hidden field from 'action' to 'quiz_action' -->
    <input type="hidden" name="quiz_action" value="generate_questions">
    <label for="prompt">Enter Prompt for Quiz Generation:</label>
    <textarea name="prompt" id="prompt" rows="4" cols="50" value="any instruction(optional)"></textarea>
    <br>
    <label for="num_questions">Number of Questions:</label>
    {% comment %} <input type="number" name="num_questions" id="num_questions" min="1" max="30" value="number of question to be generated" required> {% endcomment %}
    <input type="number" name="num_questions" id="num_questions" min="1" max="30" value="1" required oninput="validateMaxValue(this)">

    <br>
    <!-- Hidden field to hold text chunks from the uploaded file -->
    <input type="hidden" name="text_chunks" id="text_chunks">
    <button type="submit">Generate Quiz</button>
  </form>
  
  <!-- Loading Spinner for Quiz Generation -->
  <div id="quizSpinner" class="spinner" style="display: none;"></div>
  
  <div id="quizGenResponse"></div>
</section>

<section id="quiz-submission">
  <h3>Take Quiz</h3>
  <form id="quizSubmitForm" method="post" action="{% url 'quiz_submission' %}">
    {% csrf_token %}
    <!-- Hidden field with the quiz_id from quiz generation -->
    <input type="hidden" name="quiz_id" id="quiz_id">
    <div id="quizQuestions">
      <!-- Quiz questions will be dynamically injected here -->
    </div>
    <button type="submit">Submit Quiz</button>
  </form>
  <div id="quizFeedback" class="feedback"></div>
</section>

<style>
  .spinner {
    border: 8px solid #f3f3f3;       /* Light grey */
    border-top: 8px solid #3498db;     /* Blue */
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<script>
  // Helper functions to show/hide spinner for quiz generation
  function showQuizSpinner() {
    document.getElementById('quizSpinner').style.display = 'block';
  }
  function hideQuizSpinner() {
    document.getElementById('quizSpinner').style.display = 'none';
  }
  function validateMaxValue(input) {
    if (input.value > 30) {
      input.value = 30;
      alert('The maximum number of questions allowed is 30.');
    }
  }
  // Handle quiz generation: Send form, then render quiz questions based on returned JSON.
  document.getElementById('quizGenForm').addEventListener('submit', function(e) {
    e.preventDefault();
    showQuizSpinner();
    const form = e.target;
    const formData = new FormData(form);
    fetch(form.action, {
      method: 'POST',
      body: formData,
    })
    .then(response => response.json())
    .then(data => {
      hideQuizSpinner();
      if (data.error) {
        document.getElementById('quizGenResponse').innerText = data.error;
      } else {
        // Clear previous quiz generation response.
        document.getElementById('quizGenResponse').innerText = '';
        // Set the hidden quiz_id field.
        document.getElementById('quiz_id').value = data.quiz_id;
        // Render the questions.
        const quizQuestionsDiv = document.getElementById('quizQuestions');
        quizQuestionsDiv.innerHTML = '';
        const questions = data.questions.questions;
        questions.forEach((q, index) => {
          const questionDiv = document.createElement('div');
          questionDiv.className = 'question';
          const questionTitle = document.createElement('h4');
          questionTitle.textContent = `Q${index + 1}: ${q.question}`;
          questionDiv.appendChild(questionTitle);
          // Create radio buttons for each option.
          q.options.forEach(option => {
            const optionLabel = document.createElement('label');
            optionLabel.className = 'option';
            const radioInput = document.createElement('input');
            radioInput.type = 'radio';
            radioInput.name = 'Q' + (index + 1);
            radioInput.value = option;
            optionLabel.appendChild(radioInput);
            optionLabel.appendChild(document.createTextNode(" " + option));
            questionDiv.appendChild(optionLabel);
          });
          quizQuestionsDiv.appendChild(questionDiv);
        });
      }
    })
    .catch(error => {
      hideQuizSpinner();
      console.error('Error in quiz generation:', error);
    });
  });

  // Handle quiz submission: Serialize selected answers and send them via AJAX.
  document.getElementById('quizSubmitForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.target;
    const quiz_id = document.getElementById('quiz_id').value;
    const quizQuestionsDiv = document.getElementById('quizQuestions');
    const questionDivs = quizQuestionsDiv.getElementsByClassName('question');
    let student_answers = {};
    Array.from(questionDivs).forEach((div, index) => {
      const questionNumber = index + 1;
      const radios = div.querySelectorAll(`input[name="Q${questionNumber}"]`);
      let selected = "";
      radios.forEach(radio => {
        if (radio.checked) selected = radio.value;
      });
      student_answers["Q" + questionNumber] = selected;
    });

    // Prepare payload.
    const csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]').value;
    const payload = new URLSearchParams();
    payload.append("quiz_id", quiz_id);
    payload.append("student_answers", JSON.stringify(student_answers));
    payload.append("csrfmiddlewaretoken", csrfToken);

    fetch(form.action, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: payload.toString()
    })
    .then(response => response.json())
    .then(data => {
      const quizFeedbackDiv = document.getElementById('quizFeedback');
      if (data.error) {
        quizFeedbackDiv.innerText = data.error;
      } else {
        // Build detailed feedback.
        let feedbackHtml = `<p>You got ${data.total_correct} out of ${data.total_questions} correct!</p>`;
        data.feedback.forEach((item, index) => {
          feedbackHtml += `<div class="feedback-item" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc;">`;
          feedbackHtml += `<h4>Question ${index + 1}: ${item.question}</h4>`;
          // Display student's answer with visual indicator.
          if (item.is_correct) {
            feedbackHtml += `<p>Your answer: <strong>${item.student_answer}</strong> <span style="color: green;">✅ Correct</span></p>`;
          } else {
            feedbackHtml += `<p>Your answer: <strong>${item.student_answer}</strong> <span style="color: red;">❌ Incorrect</span></p>`;
            feedbackHtml += `<p>Correct answer: <strong>${item.correct_answer}</strong></p>`;
          }
          feedbackHtml += `</div>`;
        });
        quizFeedbackDiv.innerHTML = feedbackHtml;
      }
    })
    .catch(error => console.error('Error in quiz submission:', error));
  });
</script>
